name: "PR-E è§‚æµ‹ä¸æœ€å°é¥æµ‹"
description: "ä»…æ”¶é›†å¿…è¦åŒ¿åæŒ‡æ ‡ï¼ˆPVã€æœç´¢æŸ¥è¯¢åˆ†å¸ƒã€ç‚¹å‡»ä½ç½®ï¼‰ï¼Œä¸æ¥å…¥å•†ä¸šåˆ†æï¼›æœ¬åœ°å¯æŸ¥çœ‹æ—¥å¿—ï¼Œçº¿ä¸Šå†™å…¥é™æ€ JSONï¼ˆæ±‡æ€»è¦†ç›–ï¼‰"
title: "[PR-E] è§‚æµ‹ä¸æœ€å°é¥æµ‹"
labels:
  - observability
  - telemetry
  - CI
  - search-quality
body:
  - type: markdown
    attributes:
      value: |
        ## ğŸ¯ ç›®æ ‡
        - ä¸æ¥å…¥å•†ä¸šåˆ†æï¼Œä»…æ”¶é›†å¿…è¦åŒ¿åæŒ‡æ ‡ï¼šé¡µé¢ PVã€æœç´¢æŸ¥è¯¢åˆ†å¸ƒã€ç‚¹å‡»ä½ç½®
        - æœ¬åœ°å¯æŸ¥çœ‹æ—¥å¿—ï¼›çº¿ä¸Šä»¥é™æ€ JSONï¼ˆæ±‡æ€»è¦†ç›–ï¼‰å‘ˆç°
        - ç”¨äºæ”¹è¿›æœç´¢è´¨é‡ï¼Œä¸æ”¶é›† IP/UA/æŒ‡çº¹/ç¬¬ä¸‰æ–¹ Cookie

  - type: markdown
    attributes:
      value: |
        ## ğŸ§© ä»»åŠ¡

        ### 1) äº‹ä»¶æ€»çº¿ï¼ˆæµè§ˆå™¨ç«¯ï¼‰
        - æ–°å»º `docs/public/telemetry.js`ï¼Œå¯¼å‡ºï¼š`function track(eventName, payload)`
        - åŸ‹ç‚¹ï¼š
          - é¡µé¢åŠ è½½ï¼š`"pv"` `{ path, ts }`
          - æœç´¢æ‰“å¼€ï¼š`"search_open"`
          - æœç´¢æŸ¥è¯¢ï¼š`"search_query"` `{ qHash, len, ts }`ï¼ˆå‰ç«¯ `sha1(q)`ï¼Œä¸å­˜åŸæ–‡ï¼‰
          - æœç´¢ç‚¹å‡»ï¼š`"search_click"` `{ qHash, rank, url, ts }`
        - å¯¹æŸ¥è¯¢ `q` åš `sha1`ï¼Œä»…ä¿ç•™é•¿åº¦ä¸æ—¶é—´æˆ³

        ### 2) å­˜å‚¨ï¼ˆé™æ€ JSON è¿½åŠ /æ±‡æ€»ä¸¤ç§ç­–ç•¥ï¼‰
        - æœ¬åœ°/devï¼šå†™å…¥ `localStorage` å¹¶åœ¨æ§åˆ¶å°å¯å¯¼å‡º
        - çº¿ä¸Š/CIï¼šé‡‡ç”¨â€œé™æ€æ±‡æ€»æ–‡ä»¶â€æ¨¡å¼ï¼Œç”± CI åˆå¹¶ï¼Œé¿å…æµè§ˆå™¨å†™å›
          - è®¾è®¡ `data/telemetry.json`
            ```json
            {
              "updatedAt": "ISO-8601",
              "pv": { "total": 0, "byPath": {} },
              "search": {
                "queriesTop": [{ "qHash": "sha1", "count": 0, "avgLen": 0 }],
                "clicksTop": [{ "url": "/path", "count": 0, "avgRank": 0 }]
              }
            }
            ```
          - æ–°å»º `scripts/telemetry-merge.mjs`ï¼š
            - å°†æ„å»ºæœŸä¸´æ—¶æ–‡ä»¶ `data/telemetry.tmp.json` ä¸ç°æœ‰ `telemetry.json` åˆå¹¶
            - å»é‡ã€èšåˆï¼ŒTop 100 æˆªæ–­
            - å¹‚ç­‰ã€æ— å‰¯ä½œç”¨ï¼›è‹¥ `tmp` ä¸å­˜åœ¨åˆ™è·³è¿‡

        ### 3) SearchBox é›†æˆ
        - åœ¨æ‰“å¼€ã€æŸ¥è¯¢ã€ç‚¹å‡»æ—¶è°ƒç”¨ `track(...)`
        - æŸ¥è¯¢æ—¶ä½¿ç”¨ `sha1(q)` ä¸ŠæŠ¥ï¼›ç‚¹å‡»æºå¸¦ `rank`

        ### 4) CI é›†æˆ
        - åœ¨ï¼ˆVitePress build + Pagefind + Embeddingsï¼‰ç»“æŸåæ‰§è¡Œï¼š
          ```bash
          node scripts/telemetry-merge.mjs || true
          ```
        - å°†åˆå¹¶åçš„ `data/telemetry.json` å‘å¸ƒåˆ° `dist/` æ ¹ç›®å½•ï¼ˆåªè¯»é™æ€æ–‡ä»¶ï¼‰

        ### 5) é¡µé¢ä¾§å¯è§†åŒ–ï¼ˆå¯é€‰ï¼‰
        - æ–°å¢ `/about/metrics` é¡µé¢
        - è¯»å– `telemetry.json`ï¼Œå±•ç¤ºæœ€è¿‘ 30 å¤© PVã€Top æŸ¥è¯¢ï¼ˆä»… hashï¼‰ä¸ç‚¹å‡»åˆ†å¸ƒ

  - type: checkboxes
    id: acceptance
    attributes:
      label: "âœ… éªŒæ”¶æ ‡å‡†"
      description: "å®Œæˆåéœ€æ»¡è¶³ä»¥ä¸‹æ¡ä»¶"
      options:
        - label: "ä¸ä½¿ç”¨ç¬¬ä¸‰æ–¹ Cookieï¼›ä¸æ”¶é›† IP / UA / æŒ‡çº¹"
          required: true
        - label: "`telemetry.json` èƒ½è¢«é¡µé¢è¯»å–ï¼›SearchBox äº‹ä»¶å¯åœ¨æœ¬åœ° console éªŒè¯"
          required: true
        - label: "CI æ— æ–°å¢å¤–ç½‘ä¾èµ–ï¼›åˆå¹¶è„šæœ¬å¹‚ç­‰ä¸”å¯é‡å¤æ‰§è¡Œ"
          required: true
        - label: "çº¿ä¸Šè¾“å‡ºä¸ºé™æ€ `telemetry.json`ï¼ˆè¦†ç›–å†™ï¼‰ï¼Œä¸å½±å“æ ¸å¿ƒåŠŸèƒ½"
          required: true

  - type: textarea
    id: notes
    attributes:
      label: "ğŸ§ª éªŒè¯ä¸æ—¥å¿—"
      description: "è¯´æ˜æœ¬åœ°éªŒè¯æ–¹å¼ï¼ˆæ§åˆ¶å°å¯¼å‡ºã€æ ·ä¾‹äº‹ä»¶ï¼‰ã€CI åˆå¹¶æ—¥å¿—ç‰‡æ®µä¸æœ€ç»ˆ `telemetry.json` ç‰‡æ®µ"
      placeholder: |
        - æœ¬åœ°æ§åˆ¶å°è¾“å‡ºç¤ºä¾‹ï¼š
          window.__telemetry_export__()
        - CI åˆå¹¶æ—¥å¿—å…³é”®è¡Œï¼š
          [telemetry-merge] merged 123 events â†’ 58 unique
        - telemetry.json ç‰‡æ®µï¼ˆè„±æ•ï¼‰ï¼š
          { "updatedAt": "...", "pv": { ... }, "search": { ... } }

  - type: markdown
    attributes:
      value: |
        ## ğŸ” å›æ»šç­–ç•¥
        - åœ¨ SearchBox ä¸å…¥å£å¤„æ³¨é‡Š `track(...)`
        - CI æ­¥éª¤è·³è¿‡ `telemetry-merge.mjs`
        - ä¸å½±å“æ ¸å¿ƒæœç´¢ä¸ç«™ç‚¹åŠŸèƒ½

  - type: markdown
    attributes:
      value: |
        ## âš™ï¸ å®æ–½æç¤º
        - `sha1` å¯ç”¨ Web Cryptoï¼š`crypto.subtle.digest('SHA-1', ...)`
        - Top æˆªæ–­ï¼šç»Ÿä¸€æŒ‰ `count`/`weight` æ’åºåå–å‰ 100
        - æ—¶é—´å­—æ®µä½¿ç”¨ ISO å­—ç¬¦ä¸²ï¼Œåˆå¹¶æ—¶æŒ‰å¤©çª—å£èšåˆæ›´ç¨³å¥ï¼ˆå¯é€‰ï¼‰
