name: "PR-J çŸ¥è¯† API + Chat"
description: "å¯¼å‡ºåªè¯»çŸ¥è¯† APIï¼ˆæ®µè½çº§/å¯é€‰å‘é‡ï¼‰ï¼Œæä¾›æœ€å° Chat ç»„ä»¶ï¼›æ‰€æœ‰å›ç­”å¿…é¡»é™„å¯ç‚¹å‡»å¼•ç”¨ï¼Œè¯­ä¹‰å¤±è´¥è‡ªåŠ¨é™çº§ä¸º Pagefind-only"
title: "[PR-J] çŸ¥è¯† API + Chatï¼ˆå¸¦å¼•ç”¨/å¯é™çº§ï¼‰"
labels: ["knowledge-api", "chat", "search", "frontend", "static"]

body:
  - type: markdown
    attributes:
      value: |
        ## ğŸ¯ ç›®æ ‡ä¸çº¦æŸ
        - çº¯å‰ç«¯/çº¯é™æ€ï¼š**ä¸å¼•å…¥åç«¯**ï¼Œæ¥å£ä»¥é™æ€ JSON æš´éœ²ã€‚
        - **ä¸é˜»å¡é¦–å±**ï¼›æ¨¡å‹/å‘é‡ **æ‡’åŠ è½½**ï¼›å…¼å®¹ **BASE å­è·¯å¾„**ã€‚
        - è¯­ä¹‰æ£€ç´¢å¤±è´¥æˆ–æœªåŠ è½½æ¨¡å‹æ—¶ï¼Œ**è‡ªåŠ¨é™çº§ Pagefind-only**ï¼ˆå±•ç¤ºæ£€ç´¢å¡ç‰‡åˆ—è¡¨ï¼‰ã€‚
        - å›ç­”å¿…é¡»**é™„å¸¦å¯ç‚¹å‡»å¼•ç”¨**ï¼ˆâ‰¥ 2 æ¡ï¼Œå¦‚å¯ï¼‰ï¼Œç‚¹å‡»è·³è½¬åŸæ–‡é”šç‚¹ã€‚

  - type: markdown
    attributes:
      value: |
        ## ğŸ§© å¾…åŠä»»åŠ¡

        ### 1) æ„å»ºæœŸåˆ‡æ®µä¸å¯¼å‡º
        - æ–°å¢è„šæœ¬ï¼š`scripts/chunk-build.mjs`
        - æ‰«æï¼š`docs/content/**/index.md`
        - åˆ‡æ®µè§„åˆ™ï¼š**300â€“500 ä¸­æ–‡å­—ç¬¦/æ®µ**ï¼Œå°½é‡ **ä¿å¥è¾¹ç•Œ**ï¼ˆä»¥ `ã€‚ï¼ï¼Ÿï¼›\n` ç­‰æ–­å¥ï¼Œè¶…é•¿ç»§ç»­åˆ‡ï¼‰
        - å­—æ®µï¼š`{ url, title, anchor, chunk }`ï¼ˆ`anchor` æ¥è‡ªæ ‡é¢˜æˆ–è‡ªåŠ¨ç”Ÿæˆï¼‰
        - è¾“å‡ºï¼š`docs/public/api/knowledge.json`
          ```json
          { "version": 1, "items": [ { "url": "...", "title": "...", "anchor": "#...", "chunk": "..." } ] }
          ```

        ### 2) ï¼ˆå¯é€‰ï¼‰æ®µå‘é‡
        - å¤ç”¨ `embeddings.worker.js`ï¼š**é¦–æ¬¡ä½¿ç”¨**æ—¶æ‰¹é‡ç¼–ç å¹¶å†™å…¥ `localStorage`ï¼ˆkey å¸¦ç‰ˆæœ¬ï¼‰ã€‚
        - æˆ– CI å¢åŠ  `scripts/embed-chunks.mjs`ï¼ˆNode ç«¯ç¼–ç ï¼‰äº§å‡º `{ url, anchor, vec }`ï¼Œåˆå¹¶åˆ° `knowledge.json` æˆ–æ—è·¯ `knowledge.vec.json`ã€‚
        - å…è®¸å¤±è´¥ï¼Œ**ä¸è‡´æ„å»ºå¤±è´¥**ï¼ˆå¯é€šè¿‡ env æ§åˆ¶ç¡¬/è½¯å¤±è´¥ï¼‰ã€‚

        ### 3) å‰ç«¯ Chat ç»„ä»¶
        - æ–°å¢ï¼š`docs/.vitepress/theme/components/ChatWidget.vue`
        - æµç¨‹ï¼š
          1. è¾“å…¥ â†’ **æ£€ç´¢**ï¼ˆPagefind + å¯é€‰è¯­ä¹‰å‘é‡ Top-K èåˆï¼‰
          2. å– **Top-K æ®µè½**ï¼ˆé»˜è®¤ K=5ï¼‰ï¼Œåœ¨å‰ç«¯åš **ç®€çŸ­æ‘˜è¦/å›ç­”åˆæˆ**
          3. **é™„ä¸Šå¼•ç”¨åˆ—è¡¨**ï¼ˆâ‰¥2 æ¡ï¼‰â€”â€”æ ¼å¼ï¼šæ ‡é¢˜ + æ®µé”šç‚¹ + ç‚¹å‡»è·³è½¬
        - å¤±è´¥/æœªåŠ è½½æ¨¡å‹ï¼šå±•ç¤ºâ€œ**æ£€ç´¢ç»“æœå¡ç‰‡åˆ—è¡¨**â€ï¼ˆåŒ…å«æ ‡é¢˜ã€æ‘˜è¦ç‰‡æ®µã€å¼•ç”¨é“¾æ¥ï¼‰è€Œéç©ºç™½ã€‚
        - ç»„ä»¶æ‡’åŠ è½½ï¼š`import("./components/ChatWidget.vue")`

        ### 4) é›†æˆå…¥å£
        - åœ¨ `Layout.vue` å¢åŠ å…¥å£ï¼ˆå³ä¸‹æ‚¬æµ®æŒ‰é’®æˆ–å¯¼èˆªèœå•é¡¹ï¼‰
        - **ä»…åœ¨äº¤äº’æ—¶**åŠ è½½ç»„ä»¶ä¸æ¨¡å‹ï¼ˆé¿å…é¦–å±æˆæœ¬ï¼‰

        ### 5) CI é›†æˆ
        - æ„å»ºå‰æ‰§è¡Œï¼š
          ```bash
          node scripts/chunk-build.mjs
          node scripts/embed-chunks.mjs || true   # å¯é€‰
          ```
        - äº§ç‰©è½åœ¨ `docs/public/api/` å¹¶éšé™æ€èµ„æºå‘å¸ƒï¼›å…¼å®¹ BASE å­è·¯å¾„ã€‚

  - type: checkboxes
    id: acceptance
    attributes:
      label: âœ… éªŒæ”¶æ ‡å‡†
      options:
        - label: è®¿é—® `/api/knowledge.json` è¿”å› 200ï¼Œå¹¶åŒ…å«åˆ‡æ®µåçš„ `items[]`
          required: true
        - label: Chat å›å¤**æ€»å¸¦å¼•ç”¨**ï¼ˆå¯ç‚¹å‡»è·³è½¬åŸæ–‡é”šç‚¹ï¼‰ï¼Œå¼•ç”¨æ¡æ•°â‰¥2ï¼ˆè‹¥æ£€ç´¢å‘½ä¸­ä¸è¶³åˆ™å°½å¯èƒ½å¤šï¼‰
          required: true
        - label: è¯­ä¹‰æ¨¡å—ä¸å¯ç”¨æ—¶è‡ªåŠ¨é™çº§ä¸º Pagefind-onlyï¼Œå±•ç¤º**æ£€ç´¢å¡ç‰‡åˆ—è¡¨**è€Œéç©ºç™½
          required: true
        - label: BASE å­è·¯å¾„ä¸‹å…¥å£æŒ‰é’®ã€æ‡’åŠ è½½ä¸é“¾æ¥è·³è½¬å…¨éƒ¨æ­£å¸¸
          required: true

  - type: textarea
    id: api-shape
    attributes:
      label: ğŸ§¾ API ä¸æ•°æ®ç»“æ„
      description: ç²˜è´´ `knowledge.json`ï¼ˆä¸å¯é€‰ `knowledge.vec.json`ï¼‰ç¤ºä¾‹ç»“æ„ä¸å…³é”®å­—æ®µè¯´æ˜
      placeholder: |
        {
          "version": 1,
          "items": [
            { "url": "/post/x#h2-term", "title": "â€¦â€¦", "anchor": "#h2-term", "chunk": "â€¦â€¦" }
          ]
        }

  - type: textarea
    id: chat-ux
    attributes:
      label: ğŸ’¬ Chat äº¤äº’ä¸é™çº§è·¯å¾„
      description: æè¿°å›ç­”åˆæˆã€Top-K èšåˆã€å¼•ç”¨æ‹¼æ¥é€»è¾‘ï¼›ä»¥åŠè¯­ä¹‰å¤±è´¥æ—¶çš„ UI é™çº§è¡¨ç°
      placeholder: |
        - RRF/MMR èåˆç­–ç•¥ã€K/N çš„é»˜è®¤å€¼
        - å¼•ç”¨å»é‡è§„åˆ™ã€åŒæ–‡æ¡£å¤šæ®µçš„é”šç‚¹èšåˆ
        - è¯­ä¹‰å¤±è´¥ â†’ Pagefind-only çš„æç¤ºæ–‡æ¡ˆä¸å¡ç‰‡å­—æ®µ

  - type: textarea
    id: logs
    attributes:
      label: ğŸ§ª éªŒè¯ä¸æ—¥å¿—
      description: ç²˜è´´æœ¬åœ°/CI è¿è¡Œè¾“å‡ºä¸æµè§ˆå™¨æ§åˆ¶å°ç‰‡æ®µï¼ˆåŠ è½½ã€æ£€ç´¢ã€é™çº§ï¼‰
      placeholder: |
        [chunk-build] scanned 37 docs â†’ 420 chunks
        [embed-chunks] vectors: 420, dim: 384 (optional)
        [chat] fallback=pagefind-only (vector model not ready)

  - type: markdown
    attributes:
      value: |
        ## âš™ï¸ å®æ–½æç¤º
        - æ–­å¥å¯ç”¨æ­£åˆ™ `/(ã€‚|ï¼|ï¼Ÿ|ï¼›|\n)+/`ï¼Œå†æŒ‰é•¿åº¦èšåˆè‡³ 300â€“500 å­—ï¼Œè¶…é•¿åˆ‡åˆ†ã€‚
        - å¼•ç”¨ URL ç»Ÿä¸€è§„åˆ™ï¼š`url + anchor`ï¼Œç¡®ä¿ä¸ VitePress æ ‡é¢˜é”šç‚¹ç”Ÿæˆä¸€è‡´ã€‚
        - æœ¬åœ°å‘é‡ç¼“å­˜ï¼š`localStorage['vec:v1:{chunkHash}']`ï¼Œç‰ˆæœ¬å·å˜æ›´æ—¶æ•´ä½“å¤±æ•ˆã€‚
        - è·¨ BASE çš„é“¾æ¥ä¸èµ„æºåŠ è½½éœ€ä½¿ç”¨ç›¸å¯¹è·¯å¾„æˆ– `withBase()` è¾…åŠ©ã€‚

  - type: markdown
    attributes:
      value: |
        ## ğŸ” å›æ»šç­–ç•¥
        - éšè— `ChatWidget` å…¥å£ï¼Œä½†ä¿ç•™ `/api/knowledge.json` åªè¯»è®¿é—®ï¼ˆä»å¯ä¾›å¤–éƒ¨å·¥å…·ä½¿ç”¨ï¼‰ã€‚
        - ç§»é™¤å‘é‡æ­¥éª¤ï¼ˆæˆ–ç»§ç»­ä»¥ Pagefind-only æ¨¡å¼è¿è¡Œï¼‰ï¼Œä¸å½±å“æ­£æ–‡ä¸ç«™ç‚¹æœç´¢ã€‚

  - type: markdown
    attributes:
      value: |
        ## ğŸ“ è¾“å‡ºç‰©ï¼ˆPR åº”åŒ…å«ï¼‰
        - `scripts/chunk-build.mjs`ï¼ˆå¿…é€‰ï¼‰ã€`scripts/embed-chunks.mjs`ï¼ˆå¯é€‰ï¼‰
        - `docs/public/api/knowledge.json`ï¼ˆä»¥åŠå¯é€‰çš„ `knowledge.vec.json`ï¼‰
        - `docs/.vitepress/theme/components/ChatWidget.vue` ä¸ `Layout.vue` å…¥å£æ”¹åŠ¨
        - æ„å»º/CI æ—¥å¿—ï¼šåˆ‡æ®µç»Ÿè®¡ã€ï¼ˆå¯é€‰ï¼‰å‘é‡ç»Ÿè®¡ã€é™çº§éªŒè¯
