name: "PR-K æœç´¢è¯„æµ‹"
description: "å»ºç«‹ç¦»çº¿æŒ‡æ ‡ï¼ˆnDCG/MRR/Recallï¼‰ä¸çº¿ä¸Šäº¤æ›¿æ›å…‰ï¼ˆinterleaving/Team Draftï¼‰å¯¹æ¯”ç­–ç•¥ï¼Œå½¢æˆå¯é‡å¤çš„è´¨é‡é—­ç¯"
title: "[PR-K] æœç´¢è¯„æµ‹ï¼ˆç¦»çº¿æŒ‡æ ‡ + çº¿ä¸Šäº¤æ›¿æ›å…‰ï¼‰"
labels: ["search-quality", "evaluation", "telemetry", "automation"]

body:
  - type: markdown
    attributes:
      value: |
        ## ğŸ¯ ç›®æ ‡ä¸çº¦æŸ
        - å»ºç«‹**ç¦»çº¿è¯„æµ‹**ï¼ˆnDCG@10ã€MRRã€Recall@Kï¼‰ä¸**çº¿ä¸Šäº¤æ›¿æ›å…‰**ï¼ˆTeam Draft Interleavingï¼‰é—­ç¯ã€‚
        - **ä¸æ”¹å˜é»˜è®¤ä½“éªŒ**ï¼šå®éªŒä»…é€šè¿‡æŸ¥è¯¢å‚æ•°å¯ç”¨ `?variant=lex|rrf|rrf-mmr`ã€‚
        - **åŒ¿åé¥æµ‹**ï¼šä¸è®°å½•åŸæ–‡æŸ¥è¯¢ï¼Œä»…å­˜ `qHash` ä¸ç‚¹å‡»ä½æ¬¡ï¼ˆå¤ç”¨ PR-E çš„æœ€å°é¥æµ‹ï¼‰ã€‚

  - type: markdown
    attributes:
      value: |
        ## ğŸ§© å¾…åŠä»»åŠ¡

        ### 1) ç¦»çº¿è¯„æµ‹
        - æ–°å¢æ ‡æ³¨é›†ï¼š`data/gold.jsonl`ï¼ˆä¸€è¡Œä¸€æ¡æ ·æœ¬ï¼‰
          ç¤ºä¾‹ï¼š
          {"q":"åˆ†é¡µ æ€ä¹ˆ åš","positives":["/docs/pagination#intro","/docs/pagination#api"],"negatives":["/blog/unrelated"]}
        - æ–°å»ºè„šæœ¬ï¼š`scripts/eval/offline.mjs`
          - å¯¹æ¥ç°æœ‰æ£€ç´¢å‡½æ•°ï¼ˆlex/Pagefindã€rrfã€rrf+mmrï¼‰
          - è®¡ç®—ï¼š`nDCG@10`ã€`MRR`ã€`Recall@K`ï¼ˆK å¯é…ç½®ï¼Œé»˜è®¤ 10ï¼‰
          - è¾“å‡ºè¡¨æ ¼åˆ° stdoutï¼Œå¹¶ç”Ÿæˆ `scripts/eval/report.json`
        - åŸºçº¿å®ˆé—¨ï¼š`scripts/eval/baseline.json`
          ç¤ºä¾‹ï¼š
          { "nDCG@10": 0.62, "MRR": 0.58, "Recall@10": 0.75, "tolerance": 0.01 }
          - ç»“æœä½äºåŸºçº¿-å®¹å·® â†’ `process.exit(1)`
        - ç¯å¢ƒå˜é‡ï¼š
          - `EVAL_K=10`ã€`EVAL_VARIANTS="lex,rrf,rrf-mmr"`ã€`EVAL_FAIL_ON_DROP=1`

        ### 2) çº¿ä¸Šäº¤æ›¿æ›å…‰ï¼ˆInterleavingï¼‰
        - åœ¨ `SearchBox.vue` æ”¯æŒ `?variant=lex|rrf|rrf-mmr` å¼ºåˆ¶å•è·¯ï¼›é»˜è®¤ä¿æŒç°æœ‰èåˆç­–ç•¥ã€‚
        - å¢åŠ  **Team Draft Interleaving**ï¼š
          - å°†ä¸¤è·¯å€™é€‰ï¼ˆå¦‚ `lex` ä¸ `rrf-mmr`ï¼‰äº¤æ›¿åˆå¹¶ï¼Œç”Ÿæˆç»Ÿä¸€ Top-N åˆ—è¡¨
          - è®°å½•ç‚¹å‡»åå¥½ï¼šç‚¹å‡»å‘½ä¸­æºæ¨¡å‹è®° 1 åˆ†ï¼ˆå¯åŠ ä½æ¬¡æŠ˜æ‰£ï¼‰
          - é€šè¿‡ PR-E çš„ `track("search_click", { qHash, rank, url, variantA, variantB, winner })` ä¸ŠæŠ¥
        - UIï¼š
          - ä»…åœ¨æºå¸¦ `?variant` æˆ– `?ab=lex-vs-rrf-mmr` æ—¶å¯ç”¨ interleaving
          - å¤±è´¥æˆ–æœªå¯ç”¨æ—¶ï¼Œé€€å›ç°æœ‰ç»“æœå‘ˆç°

        ### 3) CI é›†æˆ
        - åœ¨ build å‰è¿è¡Œï¼ˆå…è®¸é˜ˆå€¼ç”± env æ§åˆ¶ï¼‰ï¼š
          node scripts/eval/offline.mjs
        - å°† `scripts/eval/report.json` ä½œä¸º Artifact ä¸Šä¼ ï¼›æ§åˆ¶å°æ‰“å°å…³é”®æŒ‡æ ‡ä¸å¯¹æ¯”
        - ä½äºåŸºçº¿ï¼ˆè€ƒè™‘å®¹å·®ï¼‰â†’ CI fail

  - type: checkboxes
    id: acceptance
    attributes:
      label: "âœ… éªŒæ”¶æ ‡å‡†"
      options:
        - label: "æœ¬åœ°è¿è¡Œ `node scripts/eval/offline.mjs` èƒ½è¾“å‡º nDCG@10 / MRR / Recall@Kï¼Œå¹¶ç”Ÿæˆ report.json"
          required: true
        - label: "CI ä¸­æ‰“å°ç¦»çº¿è¯„æµ‹å¯¹æ¯”ï¼Œå¹¶ä»¥ baseline å®ˆé—¨ï¼ˆä½äºé˜ˆå€¼ failï¼‰"
          required: true
        - label: "`?variant=lex|rrf|rrf-mmr` å¯åˆ‡æ¢æ£€ç´¢é€»è¾‘ï¼›ä¸å¸¦å‚æ•°æ—¶ä¿æŒé»˜è®¤ä½“éªŒ"
          required: true
        - label: "Interleaving èƒ½è®°å½•ç‚¹å‡»åå¥½å¹¶é€šè¿‡ PR-E é¥æµ‹è½åº“ï¼ˆä»…å­˜ hash ä¸ä½æ¬¡ï¼Œä¸å­˜åŸæ–‡ï¼‰"
          required: true

  - type: textarea
    id: gold-notes
    attributes:
      label: "ğŸ§¾ æ ‡æ³¨æ•°æ®è¯´æ˜"
      description: "è¯´æ˜ gold.jsonl çš„æ„å»ºåŸåˆ™ä¸è¦†ç›–èŒƒå›´ï¼›å»ºè®®åŒ…å«å¤šæ ·æ„å›¾ï¼ˆå¯¼èˆª/ä¿¡æ¯/ä»»åŠ¡ï¼‰ä¸å¤šç±»åˆ«æ–‡æ¡£"
      placeholder: |
        - æ¡ç›®æ•° / è¦†ç›–åˆ†ç±» / æ¥æº
        - positives/negatives å®šä¹‰ä¸é‡‡æ ·ç­–ç•¥
        - æ›´æ–°é¢‘ç‡ä¸å®¡é˜…æµç¨‹

  - type: textarea
    id: interleaving-notes
    attributes:
      label: "ğŸ”€ äº¤æ›¿æ›å…‰è®¾è®¡"
      description: "æè¿° Team Draft ç»†èŠ‚ã€ä½æ¬¡æŠ˜æ‰£ã€å¹³åˆ†/å¹¶åˆ—å¤„ç†ä¸â€œèƒœè€…â€ç»Ÿè®¡å£å¾„"
      placeholder: |
        - N=10ï¼›ä½æ¬¡æŠ˜æ‰£ 1/log2(1+rank)
        - åŒä¸€ URL åˆå¹¶å»é‡ç­–ç•¥
        - æ— ç‚¹å‡»/å¤šç‚¹å‡»æ—¶çš„åˆ¤å®šè§„åˆ™

  - type: textarea
    id: logs
    attributes:
      label: "ğŸ§ª éªŒè¯ä¸æ—¥å¿—"
      description: "ç²˜è´´æœ¬åœ°/CI æŒ‡æ ‡è¾“å‡ºä¸çº¿ä¸Šç‚¹å‡»åå¥½èšåˆç‰‡æ®µ"
      placeholder: |
        [eval] k=10 variants=lex,rrf,rrf-mmr
        [eval] nDCG@10: lex=0.59 rrf=0.66 rrf-mmr=0.69
        [eval] MRR:     lex=0.53 rrf=0.60 rrf-mmr=0.63
        [eval] Recall@10: lex=0.72 rrf=0.78 rrf-mmr=0.81
        [gate] against baseline nDCG@10=0.62 tol=0.01 -> PASS
        [telemetry] interleaving winner: rrf-mmr (p=0.61, n=342)

  - type: markdown
    attributes:
      value: |
        ## âš™ï¸ å®æ–½æç¤º
        - nDCGï¼šä½¿ç”¨ DCG = Î£ (rel_i / log2(1+i))ï¼Œrel_i = 1 è‹¥å‘½ä¸­ positivesï¼›IDCG ç”±ç†æƒ³æ’åºæ±‚å¾—ã€‚
        - MRRï¼šå¯¹æ¯ä¸ªæ ·æœ¬å–å‘½ä¸­ positives çš„ç¬¬ä¸€ä¸ªä½æ¬¡ 1/rankï¼›æœªå‘½ä¸­è®° 0ã€‚
        - Recall@Kï¼šK å†…å‘½ä¸­ positives çš„æ¯”ä¾‹ã€‚
        - Interleaving æ¨è Team Draftï¼ˆäº¤æ›¿æŠ½å–ï¼‰ï¼Œå¹¶åœ¨ç‚¹å‡»æ—¶è®°å½•æ¥æºæ¨¡å‹ï¼›æ”¯æŒ `?ab=a-vs-b`ã€‚
        - ä¸ PR-E é¥æµ‹æ‰“é€šæ—¶ï¼Œæ–°å¢å­—æ®µè¯·åœ¨ data/telemetry.json æ±‡æ€»ç»“æ„ä¸­ç™»è®°ã€‚

  - type: markdown
    attributes:
      value: |
        ## ğŸ” å›æ»šç­–ç•¥
        - å…³é—­ `?variant` ä¸ `?ab` åˆ†æ”¯ï¼›ç§»é™¤ interleaving å…¥å£ã€‚
        - åœ¨ CI ä¸­è·³è¿‡ `scripts/eval/offline.mjs`ï¼ˆæˆ–æ”¾å®½ baseline é˜ˆå€¼ï¼‰ã€‚
        - æœç´¢ä»æŒ‰é»˜è®¤èåˆç­–ç•¥æ‰§è¡Œï¼ŒåŠŸèƒ½ä¸å—å½±å“ã€‚
