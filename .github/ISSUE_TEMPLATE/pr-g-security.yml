name: "PR-G å®‰å…¨ä¸åˆè§„"
description: "ä¸ºç«™ç‚¹åŠ å…¥ CSPã€å®‰å…¨å¤´ä¸ SRIï¼Œå¹¶åœ¨ CI ä¸­è‡ªåŠ¨æ ¡éªŒï¼›çº¯é™æ€æ–¹æ¡ˆä¸”ä¸ç ´åç°æœ‰æ„å»ºä¸ BASE è·¯å¾„"
title: "[PR-G] å®‰å…¨ä¸åˆè§„ï¼ˆCSP / SRI / security-headersï¼‰"
labels: ["security", "ci", "automation"]
body:
  - type: markdown
    attributes:
      value: |
        ## ğŸ¯ ç›®æ ‡
        - ä¸º Ling-Atlas æä¾›é™æ€å®‰å…¨å¤´ï¼ˆCSPã€Referrerã€Permissions ç­‰ï¼‰ä¸ Subresource Integrityï¼ˆSRIï¼‰æ¸…å•ï¼›  
        - åœ¨æ„å»ºåè‡ªåŠ¨ç”Ÿæˆå¹¶æ ¡éªŒï¼›è‹¥å¤–éƒ¨ CDN å˜æ›´ä½† SRI æœªæ›´æ–°åˆ™ CI failï¼›  
        - çº¯é™æ€å®ç°ï¼ˆmeta CSP æˆ– `.well-known` æ–‡æœ¬/JSONï¼‰ï¼Œä¸æ”¹å˜ç°æœ‰æ„å»ºä¸ BASE è·¯å¾„é€»è¾‘ï¼›  
        - é›¶ç ´åï¼šåŠŸèƒ½ä¸æœ¬åœ° dev/preview ä¸å—å½±å“ã€‚

  - type: markdown
    attributes:
      value: |
        ## ğŸ§© ä»»åŠ¡æ‹†è§£

        ### 1) ç”Ÿæˆå®‰å…¨å¤´ï¼ˆé™æ€è¾“å‡ºï¼‰
        - è„šæœ¬ï¼š`scripts/generate-headers.mjs`
        - è¾“å‡ºæ–‡ä»¶ï¼š`docs/public/.well-known/security-headers.txt`
        - åŒ…å«å¤´é¡¹ï¼ˆç¤ºä¾‹ï¼‰ï¼š
          ```
          Content-Security-Policy: default-src 'self'; script-src 'self' 'sha256-__INLINE__' https://esm.sh https://cdn.jsdelivr.net 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' https:; connect-src 'self' https:; worker-src 'self' blob:; object-src 'none'; base-uri 'self'; frame-ancestors 'none';
          Referrer-Policy: no-referrer
          Permissions-Policy: geolocation=(), camera=(), microphone=()
          X-Content-Type-Options: nosniff
          Strict-Transport-Security: max-age=31536000; includeSubDomains
          ```
        - å°† CSP åŒæ­¥å†™å…¥ `docs/.vitepress/head` çš„ `<meta http-equiv="Content-Security-Policy" content="...">`ï¼ˆè‹¥æ¡†æ¶çº¦æŸï¼Œå¯ä»…ä¿ç•™ `.well-known` å¹¶åœ¨ README æ³¨æ˜ä½¿ç”¨è·¯å¾„ï¼‰
        - æ³¨æ„ï¼š`'sha256-__INLINE__'` ä¸ºå ä½ï¼ˆè„šæœ¬å¯æ›¿æ¢ä¸ºå®é™… inline è„šæœ¬ hash åˆ—è¡¨ï¼‰

        ### 2) SRI è®¡ç®—ä¸æ³¨å…¥
        - è„šæœ¬ï¼š`scripts/sri.mjs`
        - é’ˆå¯¹å¤–éƒ¨èµ„æºï¼ˆç™½åå•ï¼‰è®¡ç®— `sha384` SRI å¹¶è¾“å‡ºï¼š
          `docs/public/.well-known/sri-manifest.json`ï¼ˆæ•°ç»„å¯¹è±¡ `{ "url": "...", "integrity": "sha384-..." }`ï¼‰
        - è‡ªåŠ¨åœ¨æ³¨å…¥ç‚¹/HTML æ¨¡æ¿æˆ– worker import ä¸­é™„åŠ  `integrity` ä¸ `crossorigin="anonymous"`ï¼ˆè‹¥æ³¨å…¥ä¸å¯è¡Œï¼Œåˆ™åœ¨ README æ ‡æ³¨éœ€æ‰‹å·¥é™„åŠ ä½ç½®ï¼‰
        - è‹¥æŸ URL æ— æ³•è®¡ç®—æˆ–ä¸åœ¨ç™½åå•ï¼Œè„šæœ¬æŠ¥é”™å¹¶ `process.exit(1)`ï¼ˆCI ä¼š failï¼‰
        - ç™½åå•ä½ç½®ï¼š`scripts/sri.config.json`ï¼ˆç”±ç»´æŠ¤è€…åˆ—æ˜å…è®¸çš„å¤–éƒ¨ CDN ä¸å›ºå®šç‰ˆæœ¬ï¼‰

        ### 3) Robots ä¸ Sitemap ä¸€è‡´æ€§
        - ç¡®ä¿å­˜åœ¨ `docs/public/robots.txt`ï¼Œå±è”½æ•æ„Ÿæˆ–éå…¬å¼€è·¯å¾„ï¼ˆä¾‹å¦‚ `/data/`, `/admin/` ç­‰ï¼‰
        - åœ¨ README ä¸­æ ‡æ³¨ `robots.txt` ä¸ `sitemap.xml` çš„æ”¾ç½®ä½ç½®ä¸ç”¨é€”

        ### 4) CI é›†æˆï¼ˆåœ¨ build + search:index + embeddings:build ä¹‹åï¼‰
        - æ­¥éª¤ï¼ˆé¡ºåºï¼‰ï¼š
          1. `node scripts/generate-headers.mjs`
          2. `node scripts/sri.mjs`
        - å°†ç”Ÿæˆçš„ `.well-known/*` æ‹·è´åˆ° `dist/` æ ¹ç›®å½•ä»¥ä¾›å‘å¸ƒï¼ˆPages/åä»£å¯è¯»å–ï¼‰
        - è‹¥ `sri.mjs` æŠ¥é”™æˆ– `security-headers.txt` ç¼ºå¤± â†’ `exit(1)`ï¼ˆCI failï¼‰

        ### 5) è‡ªåŠ¨æ ¡éªŒï¼ˆè¿è¡Œæ—¶/CI æŠ¥å‘Šï¼‰
        - è¾“å‡º CI æ—¥å¿—ç‰‡æ®µï¼š
          - åˆ—å‡º SRI æ¸…å•ï¼ˆurl + integrityï¼‰
          - æ‰“å° CSP æ‘˜è¦ï¼ˆæˆ–å†™å…¥ artifactï¼‰
        - æ¨èï¼šåœ¨ CI Artifact ä¸­ä¿ç•™ `.well-known/*` ä¸æ³¨å…¥ç‚¹ç¤ºä¾‹

  - type: checkboxes
    id: acceptance
    attributes:
      label: âœ… éªŒæ”¶æ ‡å‡†
      options:
        - label: Lighthouse Best Practices â‰¥ 95 ä¸”æ§åˆ¶å°æ—  CSP è¿è§„ï¼ˆæœ¬åœ°/CI å¤ç°ï¼‰
          required: true
        - label: æ‰€æœ‰å¤–é“¾èµ„æºå‡åœ¨ `sri-manifest.json` ä¸­ï¼Œä¸”ä½¿ç”¨å¤„é™„å¸¦ `integrity` + `crossorigin="anonymous"`
          required: true
        - label: `security-headers.txt`ï¼ˆå¯é€šè¿‡ `/.well-known/security-headers.txt` è®¿é—®ï¼‰ä¸ `sri-manifest.json` å­˜åœ¨å¹¶è¢«å‘å¸ƒåˆ° `dist/`
          required: true
        - label: CI åœ¨å¤–éƒ¨ CDN å˜æ›´å¯¼è‡´ SRI ä¸åŒ¹é…æ—¶ failï¼›ä¸”å¯é€šè¿‡ç»´æŠ¤ç™½åå•/æ›´æ–° SRI æ¢å¤
          required: true

  - type: markdown
    attributes:
      value: |
        ## âš™ï¸ å®æ–½ç»†èŠ‚ä¸çº¦æŸ
        - **ä¸æ”¹å˜ BASE è·¯å¾„ æˆ– ç°æœ‰æ„å»ºé€»è¾‘ã€‚** æ‰€æœ‰ç”Ÿæˆæ–‡ä»¶æ”¾åœ¨ `docs/public/.well-known/`ï¼Œå¹¶åœ¨æœ€ç»ˆéƒ¨ç½²æ—¶å¤åˆ¶åˆ° `dist/.well-known/`ã€‚
        - SRI åªå¯¹**ç™½åå•ä¸­çš„å›ºå®šèµ„æºç‰ˆæœ¬**è®¡ç®—ï¼ˆä¾‹å¦‚ï¼š`https://esm.sh/@xenova/transformers@0.XX.XX/...`ï¼‰ã€‚ä¸é¼“åŠ±å¯¹æµ®åŠ¨ç‰ˆæœ¬æˆ– root CDN ç´¢å¼•è®¡ç®— SRIï¼ˆä¼šé¢‘ç¹å¤±æ•ˆï¼‰ã€‚
        - è‹¥æŸå¤–é“¾éœ€è¦åŠ¨æ€æ›´æ–°ï¼ˆCDN ç‰ˆæœ¬å˜æ›´ï¼‰ï¼Œç»´æŠ¤è€…éœ€ï¼š
          1. æ›´æ–° `scripts/sri.config.json` ç™½åå•ï¼ˆæ–° URLï¼‰ï¼Œ
          2. é‡æ–°è¿è¡Œ `node scripts/sri.mjs`ï¼ˆæˆ–åœ¨ PR ä¸­è®© CI è‡ªåŠ¨æ›´æ–°å¹¶é€šè¿‡å®¡æ ¸ï¼‰ã€‚
        - å¯¹äºæ— æ³•è‡ªåŠ¨æ³¨å…¥ SRI çš„åœºæ™¯ï¼Œ`sri-manifest.json` ä½œä¸ºæƒå¨æ¸…å•ï¼Œå¹¶åœ¨ README ä¸­æ ‡æ³¨æ‰‹å·¥æ³¨å…¥ä½ç½®ï¼ˆæˆ–æä¾›å°æ®µ patch/ç¤ºä¾‹ï¼‰ã€‚

  - type: textarea
    id: logs
    attributes:
      label: ğŸ§ª éªŒè¯ä¸æ—¥å¿—ï¼ˆå»ºè®®åœ¨ Issue ä¸­è´´ä¸Šï¼‰
      description: CI è¿è¡Œåè¯·ç²˜è´´å…³é”®æ—¥å¿—ç‰‡æ®µï¼ˆSRI åˆ—è¡¨ã€CSP æ‘˜è¦ã€ä»»ä½•æŠ¥é”™ï¼‰
      placeholder: |
        [generate-headers] wrote docs/public/.well-known/security-headers.txt
        [sri] computed 4 integrity entries:
          - https://esm.sh/.. -> sha384-...
        [ci] copied .well-known/* -> dist/.well-known/
        [ci] Lighthouse best-practices: 96

  - type: markdown
    attributes:
      value: |
        ## ğŸ” å›æ»šç­–ç•¥
        - ä¸´æ—¶ç§»é™¤åœ¨ `docs/.vitepress/head` çš„ meta CSP æ³¨å…¥ï¼ˆæˆ–æ¢å¤åŸæ¥æ–‡ä»¶ï¼‰ï¼›å¹¶åœ¨ CI ä¸­æ³¨é‡Šæ‰ `node scripts/generate-headers.mjs` ä¸ `node scripts/sri.mjs` æ­¥éª¤ã€‚
        - è¯¥å›æ»šä¸ä¼šå½±å“ä¸»ç«™ç‚¹åŠŸèƒ½ï¼›ä½†ä¼šçŸ­æš‚é™ä½å¯¹ CDN å˜æ›´çš„è‡ªåŠ¨æ£€æµ‹èƒ½åŠ›ã€‚

  - type: markdown
    attributes:
      value: |
        ## ğŸ“ æ¨èè¾“å‡ºç‰©ï¼ˆPR åº”åŒ…å«ï¼‰
        - `scripts/generate-headers.mjs`ï¼ˆå®ç°å¹¶æ³¨é‡Šæ¸…æ¥šï¼‰
        - `scripts/sri.mjs` ä¸ `scripts/sri.config.json`ï¼ˆç™½åå•ï¼‰
        - `.well-known/security-headers.txt`ï¼ˆç¤ºä¾‹ï¼‰
        - `.well-known/sri-manifest.json`ï¼ˆç¤ºä¾‹ï¼‰
        - README ä¸­çš„â€œå®‰å…¨å¤´ & SRIâ€ä¸€èŠ‚ï¼šæŒ‡ç¤ºå¦‚ä½•æ‰‹åŠ¨æ³¨å…¥ã€å¦‚ä½•æ›´æ–°ç™½åå•ã€å›æ»šæ­¥éª¤
        - CI workflow ä¿®æ”¹ç‰‡æ®µï¼ˆæ˜¾ç¤ºåœ¨ build åæ‰§è¡Œè¿™ä¸¤ä¸ªè„šæœ¬å¹¶å¤åˆ¶ `.well-known/*` åˆ° distï¼‰

  - type: markdown
    attributes:
      value: |
        ## å®æ–½æç¤ºï¼ˆå·¥ç¨‹å¸ˆå°è´´å£«ï¼‰
        - ä½¿ç”¨ Node çš„ `crypto` æˆ– `fetch` + `crypto.subtle` è®¡ç®—å¤–é“¾èµ„æºçš„ hashï¼ˆå»ºè®®ä¸‹è½½å†…å®¹åç”¨ `crypto.createHash('sha384').update(buf).digest('base64')`ï¼‰ã€‚
        - å¯¹äº inline scripts/stylesï¼šè„šæœ¬å¯è®¡ç®—å®é™…å†…è”å†…å®¹çš„ sha256 å¹¶æŠŠå…¶åŠ å…¥ CSP çš„ `script-src` / `style-src`ï¼ˆè‡ªåŠ¨åŒ–æ³¨å…¥æ—¶æ³¨æ„è½¬ä¹‰ï¼‰ã€‚
        - æŠŠ `.well-known/*` ä½œä¸º CI artifact ä¿ç•™ï¼Œä¾¿äº post-mortem ä¸å®¡è®¡ã€‚
